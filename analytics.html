<!DOCTYPE html>
<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ניתוח נתונים - הנדסה</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        direction: rtl;
        text-align: right;
        background-color: #f8f9fa;
        font-family: "Calibri";
      }
      .container {
        width: 100%;
      }
      .banner {
        background: linear-gradient(90deg, #007bff, #00c6ff);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
      }
      .banner img {
        width: 20%;
        padding-right: 15px;
      }
      .sidebar {
        position: fixed;
        top: 0;
        right: 0;
        height: 100%;
        width: 250px;
        background: #ebebec;
        padding-top: 20px;
        z-index: 1000;
        transition: transform 0.3s ease;
        border-left: 0.5px solid #dee2e6;
      }
      .sidebar.collapsed {
        transform: translateX(100%);
      }
      .sidebar a {
        padding: 10px 15px;
        text-decoration: none;
        font-size: 18px;
        color: black;
        display: block;
        margin-top: 10px;
        font-weight: bold;
      }
      .sidebar a:hover {
        transform: scale(1.1);
        margin: 10px;
      }
      .sidebar .title {
        color: black;
        padding: 15px;
        font-size: 30px;
        margin-top: 50px;
      }
      .toggle-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #ebebec;
        color: black;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        z-index: 1001;
        border: 2px solid black;
        font-weight: bold;
      }
      .chart-container {
        width: 45%;
        display: inline-block;
        margin: 10px;
      }
      .chart-text {
        text-align: center;
        margin-top: 10px;
      }

      /* סגנונות למצב Dark Mode */
      .dark-mode {
        background-color: #121212;
        color: #ffffff;
      }
      .dark-mode .container {
        background-color: #1e1e1e;
      }
      .dark-mode .task-item {
        background-color: #2c2c2c;
        box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
      }
      .dark-mode .priority-high {
        border-left: 5px solid #ff6b6b;
        background-color: #3b3b3b;
      }
      .dark-mode .priority-medium {
        border-left: 5px solid #ffd93b;
        background-color: #3b3b3b;
      }
      .dark-mode .priority-low {
        border-left: 5px solid #4caf50;
        background-color: #3b3b3b;
      }
      .dark-mode .sidebar {
        background-color: #2c2c2c;
        border-left: 0.5px solid #3b3b3b;
      }
      .dark-mode .sidebar a {
        color: #ffffff;
      }
      .dark-mode .sidebar a:hover {
        color: #ffd93b;
      }
      .dark-mode .toggle-btn {
        background-color: #2c2c2c;
        color: #ffffff;
        border: 2px solid #ffffff;
      }
      .dark-mode .banner {
        background: linear-gradient(90deg, #007bff, #00c6ff);
        box-shadow: 0 4px 8px rgba(255, 255, 255, 0.2);
      }
      .dark-mode .column {
        background-color: #2c2c2c;
        border: 1px solid #3b3b3b;
        color: #ffffff;
      }
      .dark-mode .footer {
        background-color: #2c2c2c;
        color: #ffffff;
      }

      .dark-mode .sidebar .title {
        color: #ffffff;
      }

      .dark-mode .sidebar button {
        border-radius: 50%;
        font-size: 20px;
        border: 1px solid #ffffff;
        background-color: #2c2c2c;
        color: #ffffff;
      }

      .sidebar-footer {
        position: fixed;
        right: 15px;
        bottom: 15px;
        width: 100%;
        color: white;
      }

      .sidebar button {
        border-radius: 50%;
        font-size: 20px;
        border: 1px solid #ffffff;
        background-color: #2c2c2c;
        color: #ffffff;
      }

      .dark-mode .chart-container {
        background-color: #2c2c2c;
        border: 1px solid #3b3b3b;
        color: #ffffff;
      }

      .dark-mode canvas {
        background-color: #2c2c2c;
      }

      .dark-mode .chart-text {
        color: #ffffff;
      }
    </style>
  </head>
  <body>
    <div class="sidebar" id="sidebar">
      <h3 class="title">מחלקת הנדסה</h3>
      <a href="index.html">בית</a>
      <hr />
      <a href="index.html">משימות</a>
      <hr />
      <a href="index.html">פניות</a>
      <hr />
      <a href="#history" onclick="showHistory()">היסטוריה</a>
      <hr />
      <a href="#alerts" onclick="showAlerts()">היסטוריית התראות</a>
      <hr />
      <a href="analytics.html">ניתוח נתונים</a>
      <footer class="sidebar-footer">
        <button id="darkModeToggle" onclick="toggleDarkMode()">
          <i id="darkModeIcon" class="fa-regular fa-moon"></i>
        </button>
      </footer>
    </div>
    <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
    <div class="container mt-1 pt-5">
      <div class="banner text-white text-center py-3 mb-4">
        <img src="logoWhite.svg" alt="תמונה" />
        <h2 class="animated-text">מחלקת הנדסה</h2>
      </div>
      <h1 class="mb-4">ניתוח נתונים</h1>
      <div class="chart-container">
        <canvas id="tasksChart"></canvas>
        <div class="chart-text">
          <p>
            גרף זה מציג את מספר הפניות והמשימות שנפתחו במהלך כל חודש קלנדרי.
            ניתן לראות את התפלגות הפניות והמשימות לאורך השנה. לדוגמה, בחודש
            ינואר נפתחו 10 פניות ומשימות, בעוד שבחודש דצמבר נפתחו 40 פניות
            ומשימות, מה שמעיד על עלייה בפעילות בסוף השנה.
          </p>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="statusChart"></canvas>
        <div class="chart-text">
          <p>
            גרף זה מציג את הסטטוס של הפניות והמשימות. ניתן לראות כמה פניות
            ומשימות הסתיימו בהצלחה, כמה נמחקו וכמה עדיין פתוחות ולא טופלו.
            לדוגמה, 50 פניות ומשימות הסתיימו בהצלחה, 10 נמחקו, ו-40 עדיין פתוחות
            ולא טופלו, מה שמעיד על הצורך בשיפור הטיפול בפניות פתוחות.
          </p>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="completionTimeChart"></canvas>
        <div class="chart-text">
          <p>
            גרף זה מציג את זמן הטיפול בפניות ובמשימות (בימים). ניתן לראות כמה
            זמן לקח לכל פניה או משימה להיות מטופלת עד שסיימתי אותה. לדוגמה, פניה
            1 לקחה 5 ימים לטיפול, בעוד שפניה 3 לקחה רק 3 ימים, מה שמעיד על שונות
            בזמני הטיפול בהתאם לסוג הפניה או המשימה.
          </p>
        </div>
      </div>
    </div>
    <!-- Modal היסטוריה -->
    <div
      class="modal fade"
      id="historyModal"
      tabindex="-1"
      aria-labelledby="historyModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="historyModalLabel">
              היסטוריית פניות ומשימות
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <ul id="historyList" class="list-group">
              <!-- היסטוריית פניות ומשימות תתווסף כאן -->
            </ul>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              סגור
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal היסטוריית התראות -->
    <div
      class="modal fade"
      id="alertsModal"
      tabindex="-1"
      aria-labelledby="alertsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alertsModalLabel">היסטוריית התראות</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <ul id="alertsList" class="list-group">
              <!-- היסטוריית התראות תתווסף כאן -->
            </ul>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              סגור
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal נתונים -->
    <div
      class="modal fade"
      id="dataModal"
      tabindex="-1"
      aria-labelledby="dataModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="dataModalLabel">נתוני פניות ומשימות</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="dataModalBody">
            <!-- נתוני פניות ומשימות יתווספו כאן -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              סגור
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-hot-toast/dist/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("collapsed");
      }

      function showHistory() {
        const historyModal = new bootstrap.Modal(
          document.getElementById("historyModal")
        );
        historyModal.show();
      }

      function showAlerts() {
        const alertsModal = new bootstrap.Modal(
          document.getElementById("alertsModal")
        );
        alertsModal.show();
      }

      // פונקציה לחישוב נתונים מה-localStorage
      function calculateData() {
        const tasks = JSON.parse(localStorage.getItem("tasks")) || [];
        const deletedTasks =
          JSON.parse(localStorage.getItem("deletedTasks")) || [];

        const monthlyData = Array(12).fill(0);
        const statusData = { completed: 0, deleted: 0, open: 0 };
        const completionTimes = [];
        const taskDetails = [];

        tasks.forEach((task) => {
          const month = new Date(task.startDate).getMonth();
          monthlyData[month]++;
          taskDetails.push({
            name: task.text,
            description: task.description,
            startDate: task.startDate,
            endDate: task.endDate || "לא צוין",
            completionDate: task.completionDate || "לא הושלם",
          });
          if (task.completionDate) {
            statusData.completed++;
            const startDate = new Date(task.startDate);
            const completionDate = new Date(task.completionDate);
            const timeDiff =
              (completionDate - startDate) / (1000 * 60 * 60 * 24);
            completionTimes.push(timeDiff);
          } else {
            statusData.open++;
          }
        });

        deletedTasks.forEach((task) => {
          statusData.deleted++;
          taskDetails.push({
            name: task.text,
            description: task.description,
            startDate: task.startDate,
            endDate: task.endDate || "לא צוין",
            completionDate: "נמחק",
          });
        });

        return { monthlyData, statusData, completionTimes, taskDetails };
      }

      // נתונים מה-localStorage
      const { monthlyData, statusData, completionTimes, taskDetails } =
        calculateData();

      const tasksData = {
        labels: [
          "ינואר",
          "פברואר",
          "מרץ",
          "אפריל",
          "מאי",
          "יוני",
          "יולי",
          "אוגוסט",
          "ספטמבר",
          "אוקטובר",
          "נובמבר",
          "דצמבר",
        ],
        datasets: [
          {
            label: "פניות ומשימות שנפתחו",
            data: monthlyData,
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            borderColor: "rgba(75, 192, 192, 1)",
            borderWidth: 1,
          },
        ],
      };

      const statusChartData = {
        labels: ["הסתיימו בהצלחה", "נמחקו", "פתוחות ולא טופלו"],
        datasets: [
          {
            label: "סטטוס פניות ומשימות",
            data: [statusData.completed, statusData.deleted, statusData.open],
            backgroundColor: [
              "rgba(75, 192, 192, 0.2)",
              "rgba(255, 99, 132, 0.2)",
              "rgba(255, 206, 86, 0.2)",
            ],
            borderColor: [
              "rgba(75, 192, 192, 1)",
              "rgba(255, 99, 132, 1)",
              "rgba(255, 206, 86, 1)",
            ],
            borderWidth: 1,
          },
        ],
      };

      const completionTimeData = {
        labels: completionTimes.map((_, index) => `פניה ${index + 1}`),
        datasets: [
          {
            label: "זמן טיפול בפניות ומשימות (ימים)",
            data: completionTimes,
            backgroundColor: "rgba(153, 102, 255, 0.2)",
            borderColor: "rgba(153, 102, 255, 1)",
            borderWidth: 1,
          },
        ],
      };

      window.onload = function () {
        const ctx1 = document.getElementById("tasksChart").getContext("2d");
        const tasksChart = new Chart(ctx1, {
          type: "bar",
          data: tasksData,
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const monthTasks = taskDetails.filter(
                  (task) => new Date(task.startDate).getMonth() === index
                );
                showModal(monthTasks);
              }
            },
          },
        });

        const ctx2 = document.getElementById("statusChart").getContext("2d");
        const statusChart = new Chart(ctx2, {
          type: "pie",
          data: statusChartData,
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
              },
              tooltip: {
                callbacks: {
                  label: function (tooltipItem) {
                    return tooltipItem.label + ": " + tooltipItem.raw;
                  },
                },
              },
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const statusTasks = taskDetails.filter((task) => {
                  if (index === 0)
                    return (
                      task.completionDate !== "לא הושלם" &&
                      task.completionDate !== "נמחק"
                    );
                  if (index === 1) return task.completionDate === "נמחק";
                  if (index === 2) return task.completionDate === "לא הושלם";
                });
                showModal(statusTasks);
              }
            },
          },
        });

        const ctx3 = document
          .getElementById("completionTimeChart")
          .getContext("2d");
        const completionTimeChart = new Chart(ctx3, {
          type: "line",
          data: completionTimeData,
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const task = taskDetails[index];
                showModal([task]);
              }
            },
          },
        });
      };

      function showModal(tasks) {
        const modalBody = document.getElementById("dataModalBody");
        modalBody.innerHTML = tasks
          .map(
            (task) => `
                <p><strong>שם:</strong> ${task.name}</p>
                <p><strong>תיאור:</strong> ${task.description}</p>
                <p><strong>תאריך התחלה:</strong> ${task.startDate}</p>
                <p><strong>תאריך סיום:</strong> ${task.endDate}</p>
                <p><strong>תאריך סיום בפועל:</strong> ${task.completionDate}</p>
            `
          )
          .join("<hr>");
        const dataModal = new bootstrap.Modal(
          document.getElementById("dataModal")
        );
        dataModal.show();
      }

      function toggleDarkMode() {
        const body = document.body;
        const icon = document.getElementById("darkModeIcon");
        body.classList.toggle("dark-mode");
        if (body.classList.contains("dark-mode")) {
          icon.classList.remove("fa-moon");
          icon.classList.add("fa-sun");
          localStorage.setItem("darkMode", "enabled");
        } else {
          icon.classList.remove("fa-sun");
          icon.classList.add("fa-moon");
          localStorage.setItem("darkMode", "disabled");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const darkMode = localStorage.getItem("darkMode");
        const body = document.body;
        const icon = document.getElementById("darkModeIcon");
        if (darkMode === "enabled") {
          body.classList.add("dark-mode");
          icon.classList.remove("fa-moon");
          icon.classList.add("fa-sun");
        } else {
          body.classList.remove("dark-mode");
          icon.classList.remove("fa-sun");
          icon.classList.add("fa-moon");
        }
      });
    </script>
  </body>
</html>
