<!DOCTYPE html>
<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ניהול פניות ומשימות - הנדסה</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/npm/react-hot-toast/dist/index.css"
    />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <!-- FullCalendar CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        direction: rtl;
        text-align: right;
        background-color: #f8f9fa;
        font-family: "Calibri";
        transition: 0.1s ease-in-out;
      }
      .container {
        width: 100%;
        transition: 0.1s ease-in-out;
      }
      .search-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .search-container input {
        display: none;
        margin-left: 10px;
        flex-grow: 1;
        transition: width 0.3s ease, opacity 0.3s ease;
        width: 0;
        opacity: 0;
      }
      .search-container input.show {
        display: block;
        width: 200px;
        opacity: 1;
      }
      .task-item {
        background-color: #ffffff;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 10px;
        padding: 10px;
        position: relative;
        width: 100%;
        cursor: move;
      }
      .priority-high {
        border-left: 5px solid #dc3545;
        background-color: #f8d7da;
      }
      .priority-medium {
        border-left: 5px solid #ffc107;
        background-color: #fff3cd;
      }
      .priority-low {
        border-left: 5px solid #28a745;
        background-color: #d4edda;
      }
      .form-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .form-group label {
        flex: 1 1 100%;
      }
      .form-group input,
      .form-group select {
        flex: 1 1 calc(50% - 10px);
      }
      .description-group {
        display: none;
        flex-direction: column;
      }
      .task-text {
        font-weight: bold;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .task-description {
        margin-top: 10px;
      }
      .task-divider {
        border-top: 1px solid #dee2e6;
        margin: 10px 0;
      }
      .task-actions {
        display: flex;
        gap: 10px;
      }
      .task-actions .btn {
        flex: 0 0 auto;
        width: auto;
      }

      .task-actions .dropdown {
        flex: 0 0 auto;
        text-align: center;
      }

      .task-actions .form-select {
        width: auto;
        flex: 0 0 auto;
      }
      .task-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .column {
        flex: 1;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: #ffffff;
      }
      .columns {
        display: flex;
        justify-content: space-between;
        gap: 20px;
      }
      .banner {
        background: linear-gradient(90deg, #007bff, #00c6ff);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        overflow: hidden;
        display: flex;
      }
      .animated-text {
        display: inline-block;
        padding-left: 15px;
      }
      @keyframes float {
        0% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-20px);
        }
        100% {
          transform: translateY(0);
        }
      }
      .info-icon {
        display: inline-block;
        color: #007bff;
        cursor: pointer;
        position: relative;
        margin-left: 10px;
        font-size: 20px;
      }
      .info-icon:hover .info-content {
        display: block;
        font-size: 13px;
      }
      .info-content {
        display: none;
        position: absolute;
        top: 25px;
        right: 0;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 200px;
      }
      .accordion-button {
        cursor: pointer;
        background-color: #f8f9fa;
        border: none;
        outline: none;
        width: 100%;
        text-align: right;
        padding: 10px;
        font-size: 16px;
        transition: background-color 0.3s ease;
        font-size: 20px;
        font-weight: bold;
      }
      .accordion-content {
        display: none;
        padding: 10px;
        border-top: 1px solid rgb(66, 66, 66);
      }
      .accordion-content.show {
        display: block;
      }
      .button-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      .left-buttons {
        display: flex;
        gap: 10px;
      }
      .right-buttons {
        display: flex;
        gap: 10px;
      }
      .banner img {
        width: 20%;
        padding-right: 15px;
      }
      /*Sidebar*/
      .sidebar {
        position: fixed;
        top: 0;
        right: 0;
        height: 100%;
        width: 250px;
        background: #ebebec;
        padding-top: 20px;
        z-index: 1000;
        transition: 0.1s ease-in-out;
        border-left: 0.5px solid #dee2e6;
      }
      .sidebar.collapsed {
        width: 85px;
        padding-top: 140px;
        transition: 0.1s ease-in-out;
      }
      .sidebar.collapsed .title,
      .sidebar.collapsed .link-text {
        display: none;
      }
      .sidebar.collapsed a {
        justify-content: center;
      }
      .sidebar a .link-icon {
        margin-left: 10px;
      }
      .sidebar a {
        padding: 10px 15px;
        text-decoration: none;
        font-size: 18px;
        color: white;
        display: flex;
        align-items: center;
        margin-top: 10px;
        transition: background-color 0.3s ease;
        color: black;
      }
      .sidebar a:hover {
        background-color: #bdbebe;
      }
      .sidebar .title {
        color: black;
        padding: 15px;
        font-size: 30px;
        margin-top: 50px;
      }
      .sidebar button {
        border-radius: 50%;
        font-size: 20px;
        border: 2px solid white;
        background-color: #343a40;
        color: white;
      }
      .toggle-btn {
        position: fixed;
        top: 20px;
        right: 18px;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
        z-index: 1001;
        border: 2px solid black;
        font-weight: bold;
        transition: transform 0.3s ease-in-out;
      }
      /*Sidebar Footer*/
      .sidebar-footer {
        position: fixed;
        right: 15px;
        bottom: 15px;
        width: 100%;
        color: white;
      }
      .sidebar.collapsed .toggle-button {
        position: fixed;
        bottom: 15px;
        right: 15px;
      }
      .toggle-button {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
      }
      .toggle-button input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 30px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        transition: 0.4s;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-image: url("https://cdn-icons-png.flaticon.com/512/702/702471.png");
        background-size: cover;
      }
      input:checked + .slider {
        background-color: #121212;
      }
      input:checked + .slider:before {
        transform: translateX(30px);
        background-image: url("https://cdn-icons-png.flaticon.com/512/439/439842.png");
      }
      .dark-mode {
        background-color: #121212;
        color: #ffffff;
      }
      .toast {
        visibility: hidden;
        max-width: 50%;
        margin: 0 auto;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 5px;
        padding: 16px;
        position: fixed;
        z-index: 1;
        left: 50%;
        top: 30px;
        font-size: 17px;
        transform: translateX(-50%);
      }
      .toast.show {
        visibility: visible;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }
      @keyframes fadein {
        from {
          top: 0;
          opacity: 0;
        }
        to {
          top: 30px;
          opacity: 1;
        }
      }
      @keyframes fadeout {
        from {
          top: 30px;
          opacity: 1;
        }
        to {
          top: 0;
          opacity: 0;
        }
      }
      .alert {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1050;
        display: none;
      }
      .footer {
        position: static;
        left: 0;
        bottom: 0;
        margin-top: 20px;
        width: 100%;
        background-color: #ebebec;
        text-align: center;
      }
      /* סגנונות למצב Dark Mode */
      .dark-mode {
        transition: 0.1s ease-in-out;
        background-color: #121212;
        color: #ffffff;
      }
      .dark-mode .container {
        transition: 0.1s ease-in-out;
        background-color: #1e1e1e;
      }
      .dark-mode .task-item {
        background-color: #2c2c2c;
        box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
        transition: 0.1s ease-in-out;
      }
      .dark-mode .priority-high {
        border-left: 5px solid #ff6b6b;
        background-color: #3b3b3b;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .priority-medium {
        border-left: 5px solid #ffd93b;
        background-color: #3b3b3b;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .priority-low {
        border-left: 5px solid #4caf50;
        background-color: #3b3b3b;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .sidebar {
        background-color: #2c2c2c;
        border-left: 0.5px solid #3b3b3b;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .sidebar a {
        color: #ffffff;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .toggle-btn {
        background-color: #2c2c2c;
        color: #ffffff;
        border: 2px solid #ffffff;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .banner {
        background: linear-gradient(90deg, #007bff, #00c6ff);
        box-shadow: 0 4px 8px rgba(255, 255, 255, 0.2);
        transition: 0.1s ease-in-out;
      }
      .dark-mode .column {
        background-color: #2c2c2c;
        border: 1px solid #3b3b3b;
        color: #ffffff;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .footer {
        background-color: #2c2c2c;
        color: #ffffff;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .sidebar .title {
        color: #ffffff;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .sidebar button {
        border-radius: 50%;
        font-size: 20px;
        border: 2px solid #ffffff;
        background-color: #2c2c2c;
        color: #ffffff;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .modal-content {
        background-color: #2c2c2c;
        color: #ffffff;
        border: 1px solid #3b3b3b;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .modal-header {
        border-bottom: 1px solid #3b3b3b;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .modal-footer {
        border-top: 1px solid #3b3b3b;
        transition: 0.1s ease-in-out;
      }
      .dark-mode .btn-close {
        filter: invert(1);
        transition: 0.1s ease-in-out;
      }
      .dark-mode .list-group-item {
        background-color: #2c2c2c;
        color: #ffffff;
        border: 1px solid #3b3b3b;
      }
      /*Settings button*/
      .settings-content {
        display: none;
        padding: 10px;
        border-top: 1px solid rgb(66, 66, 66);
        background-color: #f8f9fa;
        position: absolute;
        bottom: 60px;
        right: 15px;
        width: 200px; /* הרחבת הרוחב */
        background: #ccc;
        border-radius: 10px; /* פינות מעוגלות */
      }
      .settings-content.show {
        display: block;
      }
      .settings-button {
        color: black;
        border: none;
        cursor: pointer;
        transition: 0.1s ease-in-out;
        width: 50px;
      }
      .settings-content button {
        color: black; /* צבע טקסט לבן */
        border: none; /* ללא גבול */
        border-radius: 5px; /* פינות מעוגלות */
        padding: 10px 15px; /* ריווח פנימי */
        font-size: 14px; /* גודל טקסט */
        font-weight: bold; /* טקסט מודגש */
        cursor: pointer; /* סמן עכבר */
        background-color: white;
        width: 100%;
        transition: background-color 0.1s ease, color 0.3s ease; /* אנימציה */
      }
      .settings-content button:hover {
        background-color: aliceblue;
      }
      .settings-content button + button {
        margin-top: 10px; /* רווח בין הכפתורים */
      }
      .sidebar.collapsed .settings-button {
        display: none;
      }
      .settings-content button.active {
        background-color: #dc3545; /* צבע רקע כחול */
        color: white; /* צבע טקסט לבן */
        border: 1px solid #dc3545; /* גבול כהה */
      }
      .settings-button img {
        transition: transform 0.3s ease-in-out; /* אנימציה חלקה */
      }
      .settings-button:hover img {
        transform: rotate(90deg); /* סיבוב של 180 מעלות */
      }
      /*Darkmode Settings button*/
      .dark-mode .settings-content button {
        color: black; /* צבע טקסט לבן */
        border: none; /* ללא גבול */
        border-radius: 5px; /* פינות מעוגלות */
        padding: 10px 15px; /* ריווח פנימי */
        font-size: 14px; /* גודל טקסט */
        font-weight: bold; /* טקסט מודגש */
        cursor: pointer; /* סמן עכבר */
        background-color: white;
        width: 100%;
      }
      .dark-mode .settings-button img {
        transition: transform 0.3s ease-in-out; /* אנימציה חלקה */
        filter: invert(1); /* הופך את הצבעים של האייקון */
      }
      .dark-mode .settings-content button:hover {
        background-color: aliceblue;
      }
      .dark-mode .settings-content button.active {
        background-color: #dc3545; /* צבע רקע כחול */
        color: white; /* צבע טקסט לבן */
        border: 1px solid #dc3545; /* גבול כהה */
      }
      .dark-mode .modal-delete-confirmation .modal-content {
        background-color: #f8d7da;
        color: black;
      }
      /*Modal delete confirmation*/
      .modal-delete-confirmation {
        max-width: 400px; /* קביעת רוחב מקסימלי */
        margin: 30vh auto; /* מיקום במרכז המסך */
      }
      .modal-delete-confirmation .modal-content {
        background-color: #f8d7da;
      }
      /*Import/Export style*/
      .import-export {
        display: flex;
        justify-content: end;
        align-items: center;
        margin-top: auto;
      }
      .dark-mode .import-export .tooltip-modal {
        color: black;
      }
      .tooltip-modal {
        display: none;
        position: absolute;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        width: 200px;
        margin-bottom: 120px;
      }
      .button-group:hover .tooltip-modal {
        display: block;
      }

      /*History CSS*/

      .modal-body {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #historyList .list-group-item {
        margin-bottom: 10px; /* Adjust the value as needed */
        border: 1px solid rgb(119, 119, 119);
        border-radius: 5px;
      }

      #historySearchInput {
        display: block;
        width: 100%;
        opacity: 1;
        transition: none; /* Remove any transition effects */
      }

      /*Dropdown רמת סיווג/רמת חשיבות*/
      .dropdown .classification {
        width: 70px;
      }

      /*לוח שנה*/
      #calendar {
        max-width: 100%;
        margin: 0 auto;
      }
      .modal-body {
        overflow-y: auto;
        padding: 20px;
      }
      .modal-content {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .modal-header {
        background-color: #007bff;
        color: white;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
      }
      .modal-header .btn-close {
        filter: invert(1);
      }
    </style>
  </head>
  <body>
    <div id="toast" class="toast"></div>
    <div
      class="alert alert-danger alert-dismissible fade show"
      role="alert"
      id="deadlineAlert"
    >
      <strong>תזכורת:</strong>
      <button
        type="button"
        class="btn-close"
        onclick="closeAlert()"
        aria-label="Close"
        style="color: black"
      ></button>
    </div>
    <div class="sidebar" id="sidebar">
      <h3 class="title">מחלקת הנדסה</h3>
      <a href="index.html"
        ><i class="fas fa-home link-icon"></i
        ><span class="link-text">בית</span></a
      >
      <hr />
      <a href="index.html"
        ><i class="fas fa-tasks link-icon"></i
        ><span class="link-text">משימות</span></a
      >
      <hr />
      <a href="index.html"
        ><i class="fas fa-envelope link-icon"></i
        ><span class="link-text">פניות</span></a
      >
      <hr />
      <a href="#history" onclick="showHistory()"
        ><i class="fas fa-history link-icon"></i
        ><span class="link-text">היסטוריה</span></a
      >
      <hr />
      <a href="#alerts" onclick="showAlerts()"
        ><i class="fas fa-bell link-icon"></i
        ><span class="link-text">היסטוריית התראות</span></a
      >
      <hr />
      <a href="analytics.html"
        ><i class="fas fa-chart-bar link-icon"></i
        ><span class="link-text">ניתוח נתונים</span></a
      >
      <span class="btn mt-2 settings-button" onclick="toggleSettings()">
        <img
          src="https://cdn-icons-png.flaticon.com/512/2099/2099058.png"
          alt="Settings"
          style="
            width: 25px;
            height: 25px;
            margin-top: 220px;
            margin-right: 10px;
          "
        />
      </span>
      <footer class="sidebar-footer">
        <label class="toggle-button">
          <input type="checkbox" id="darkModeToggle" />
          <span class="slider"></span>
        </label>
        <div id="settingsContent" class="settings-content">
          <button
            class="btn btn-light btn-sm"
            onclick="toggleColumn('tasksColumn', this)"
          >
            הסתר/הצג עמודת משימות
          </button>
          <button
            class="btn btn-light btn-sm"
            onclick="toggleColumn('requestsColumn', this)"
          >
            הסתר/הצג עמודת פניות
          </button>
        </div>
      </footer>
    </div>
    <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
    <div class="container mt-1 pt-5">
      <div
        class="banner text-white text-center py-3 mb-4 flex justify-content-between"
      >
        <img src="logoWhite.svg" alt="תמונה" />
        <h2 class="animated-text">מחלקת הנדסה</h2>
      </div>
      <h1 class="mb-4">ניהול פניות ומשימות</h1>
      <div class="form-group mb-3">
        <div>
          <label for="newTask" class="form-label">פניה חדשה*</label>
          <input
            type="text"
            id="newTask"
            class="form-control"
            placeholder="הוסף פניה חדשה"
          />
        </div>
        <div>
          <label for="startDate" class="form-label">תאריך התחלה*</label>
          <input type="datetime-local" id="startDate" class="form-control" />
        </div>
        <div>
          <label for="endDate" class="form-label">תאריך יעד סופי</label>
          <input type="datetime-local" id="endDate" class="form-control" />
        </div>
        <div>
          <label for="priority" class="form-label">רמת חשיבות*</label>
          <select id="priority" class="form-select">
            <option value="">בחר</option>
            <option value="low">נמוכה</option>
            <option value="medium">בינונית</option>
            <option value="high">גבוהה</option>
          </select>
        </div>
        <div>
          <label for="taskType" class="form-label">סיווג*</label>
          <select id="taskType" class="form-select">
            <option value="">בחר סיווג</option>
            <option value="task">משימה</option>
            <option value="request">פניה</option>
          </select>
        </div>
        <div>
          <label for="urgent" class="form-label">דחוף</label>
          <input type="checkbox" id="urgent" name="urgent" />
        </div>
      </div>
      <div class="form-group mb-3 description-group">
        <label for="description" class="form-label">תיאור</label>
        <textarea
          id="description"
          class="form-control"
          placeholder="תיאור הפניה/משימה"
        ></textarea>
      </div>
      <div class="button-group mb-3">
        <div class="left-buttons">
          <button class="btn btn-secondary" onclick="toggleDescription()">
            הוסף תיאור
          </button>
          <button class="btn btn-primary" onclick="addTask()">הוסף</button>
        </div>
        <div class="right-buttons">
          <div class="search-container m-auto p-auto">
            <button
              class="btn btn-secondary m-auto p-auto"
              onclick="toggleSearch()"
            >
              <i class="fa fa-search"></i>
            </button>
            <input
              type="text"
              id="searchInput"
              class="form-control"
              placeholder="חפש פניות/משימות"
              oninput="filterTasks()"
            />
          </div>
          <button
            class="btn btn-secondary m-auto p-auto"
            onclick="showHistory()"
          >
            היסטוריה
          </button>
          <button
            class="btn btn-secondary m-auto p-auto"
            onclick="showAlerts()"
          >
            היסטוריית התראות
          </button>
          <!-- כפתור לפתיחת לוח השנה -->
          <button
            class="btn btn-primary position-relative"
            data-bs-toggle="modal"
            data-bs-target="#calendarModal"
          >
            <i class="fa fa-calendar"></i> לוח שנה
            <span
              id="eventCountBadge"
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              style="display: none"
            >
              0
            </span>
          </button>

          <!-- מודאל של לוח השנה -->
          <div
            class="modal fade"
            id="calendarModal"
            tabindex="-1"
            aria-labelledby="calendarModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="calendarModalLabel">לוח שנה</h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <div id="calendar"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- מודאל להוספת משימה/פגישה -->
          <div
            class="modal fade"
            id="addEventModal"
            tabindex="-1"
            aria-labelledby="addEventModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="addEventModalLabel">
                    הוסף משימה/פגישה
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <form id="addEventForm">
                    <div class="mb-3">
                      <label for="newEventTitle" class="form-label"
                        >כותרת</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="newEventTitle"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="newEventDate" class="form-label"
                        >תאריך ושעה</label
                      >
                      <input
                        type="datetime-local"
                        class="form-control"
                        id="newEventDate"
                        required
                      />
                    </div>
                    <button type="submit" class="btn btn-primary">הוסף</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- מודאל לעריכת משימה/פגישה -->
          <div
            class="modal fade"
            id="editEventModal"
            tabindex="-1"
            aria-labelledby="editEventModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="editEventModalLabel">
                    ערוך משימה/פגישה
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <form id="editEventForm">
                    <div class="mb-3">
                      <label for="eventTitle" class="form-label">כותרת</label>
                      <input
                        type="text"
                        class="form-control"
                        id="eventTitle"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="eventDate" class="form-label"
                        >תאריך ושעה</label
                      >
                      <input
                        type="datetime-local"
                        class="form-control"
                        id="eventDate"
                        required
                      />
                    </div>
                    <button type="submit" class="btn btn-primary">שמור</button>
                    <button
                      type="button"
                      class="btn btn-danger"
                      id="deleteEventButton"
                    >
                      מחק
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- התראה בעמוד הראשי -->
          <div
            id="alert"
            class="alert alert-warning alert-dismissible fade show"
            role="alert"
            style="
              display: none;
              position: fixed;
              top: 10px;
              right: 10px;
              z-index: 1050;
            "
          >
            <strong>תזכורת:</strong> יש לך משימה/פגישה קרובה.
            <button
              type="button"
              class="btn-close"
              onclick="closeAlert()"
              aria-label="Close"
            ></button>
          </div>
        </div>
      </div>
      <hr />
      <div class="columns">
        <div class="column" id="tasksColumn">
          <h3 id="tasks">משימות</h3>
          <div id="taskAccordion">
            <!-- משימות יתווספו כאן -->
          </div>
        </div>
        <div class="column" id="requestsColumn">
          <h3 id="requests">פניות</h3>
          <div id="requestAccordion">
            <!-- פניות יתווספו כאן -->
          </div>
        </div>
      </div>
      <hr />
      <div class="button-group import-export mt-5 mb-0">
        <button
          class="btn btn-success"
          onclick="exportData()"
          onmouseover="showTooltip('exportTooltip')"
          onmouseout="hideTooltip('exportTooltip')"
        >
          <img
            src="https://cdn-icons-png.flaticon.com/512/8828/8828334.png"
            alt="Export Icon"
            style="width: 20px; height: 20px"
          />
        </button>
        <div id="exportTooltip" class="tooltip-modal">
          פעולה זו תייצא את כל הנתונים לקובץ JSON.
          <b>לגיבוי בלבד</b>
        </div>
        <input
          type="file"
          id="importFileInput"
          class="d-none"
          onchange="importData(event)"
        />
        <button
          class="btn btn-success"
          onclick="document.getElementById('importFileInput').click()"
          onmouseover="showTooltip('importTooltip')"
          onmouseout="hideTooltip('importTooltip')"
        >
          <img
            src="https://cdn-icons-png.flaticon.com/512/8765/8765164.png"
            alt="Import Icon"
            style="width: 20px; height: 20px"
          />
        </button>
        <div id="importTooltip" class="tooltip-modal">
          פעולה זו תייבא נתונים מקובץ JSON.
        </div>
      </div>
    </div>
    <div class="footer">
      <i class="fa-regular fa-copyright"></i> הוקם ע"י טל יעקב - מחלקת הנדסה
    </div>
    <!-- Modal להיסטוריה -->
    <div
      class="modal fade"
      id="historyModal"
      tabindex="-1"
      aria-labelledby="historyModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="historyModalLabel">היסטוריה</h5>
            &nbsp;&nbsp;&nbsp;
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="search-container w-50">
              <button class="btn btn-secondary" onclick="toggleHistorySearch()">
                <i class="fa fa-search"></i>
              </button>
              <input
                type="text"
                id="historySearchInput"
                class="form-control"
                placeholder="חפש משימות שהסתיימו"
                oninput="filterHistoryTasks()"
              />
            </div>
            <ul id="historyList" class="list-group">
              <!-- פריטים יתווספו כאן -->
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal להיסטוריית התראות -->
    <div
      class="modal fade"
      id="alertsModal"
      tabindex="-1"
      aria-labelledby="alertsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alertsModalLabel">היסטוריית התראות</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <ul id="alertsList" class="list-group">
              <!-- פריטים יתווספו כאן -->
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal לסיבת סיום -->
    <div
      class="modal fade"
      id="completionReasonModal"
      tabindex="-1"
      aria-labelledby="completionReasonModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="completionReasonModalLabel">
              סיבת סיום
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="completionReasonForm">
              <div class="mb-3">
                <label for="completionReason" class="form-label"
                  >בחר סיבת סיום</label
                >
                <select id="completionReason" class="form-select">
                  <option value="סיום משימה/פניה">סיום משימה/פניה</option>
                  <option value="בוטל">בוטל</option>
                  <option value="הועבר למחלקה אחרת">הועבר למחלקה אחרת</option>
                  <option value="לא רלוונטי">לא רלוונטי</option>
                  <option value="אחר">אחר</option>
                </select>
              </div>
              <div class="mb-3" id="otherReasonGroup" style="display: none">
                <label for="otherReason" class="form-label">סיבה אחרת</label>
                <input
                  type="text"
                  id="otherReason"
                  class="form-control"
                  placeholder="הכנס סיבה אחרת"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              סגור
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="completeTask()"
            >
              סיים
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Modal למחיקת פניה/משימה -->
    <div
      class="modal fade"
      id="deleteConfirmationModal"
      tabindex="-1"
      aria-labelledby="deleteConfirmationModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-delete-confirmation">
        <div class="modal-content">
          <div class="modal-header">
            <i class="fas fa-exclamation-triangle text-danger"></i>
            <h5 class="modal-title" id="deleteConfirmationModalLabel">
              אישור מחיקה
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              שים לב! פעולת המחיקה תמחק לנצח את הפניה/משימה. האם אתה בטוח
              שברצונך להמשיך?
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ביטול
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="confirmDeleteButton"
              disabled
            >
              מחק
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/react-hot-toast/dist/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <script>
      let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
      let deletedTasks = JSON.parse(localStorage.getItem("deletedTasks")) || [];
      let alerts = JSON.parse(localStorage.getItem("alerts")) || [];
      document.addEventListener("DOMContentLoaded", () => {
        const startDateInput = document.getElementById("startDate");
        const now = new Date();
        const jerusalemTime = new Date(now.getTime() + 2 * 3600000);
        const formattedDate = jerusalemTime.toISOString().slice(0, 16);
        startDateInput.value = formattedDate;
        renderTasks();
        checkDeadlines();
        const taskColumn = document.getElementById("taskAccordion");
        const requestColumn = document.getElementById("requestAccordion");
        new Sortable(taskColumn, {
          group: "tasks",
          animation: 150,
          onEnd: function (evt) {
            console.log("Task moved:", evt.item);
          },
        });
        new Sortable(requestColumn, {
          group: "tasks",
          animation: 150,
          onEnd: function (evt) {
            console.log("Request moved:", evt.item);
          },
        });
        setInterval(checkDeadlines, 60000); // בדיקת תאריכי יעד כל דקה
      });

      function toggleDescription() {
        const descriptionGroup = document.querySelector(".description-group");
        descriptionGroup.style.display =
          descriptionGroup.style.display === "none" ? "flex" : "none";
      }

      function addTask() {
        const newTaskInput = document.getElementById("newTask");
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");
        const priorityInput = document.getElementById("priority");
        const taskTypeInput = document.getElementById("taskType");
        const descriptionInput = document.getElementById("description");
        const urgentInput = document.getElementById("urgent");
        const newTaskText = newTaskInput.value.trim();
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        const priority = priorityInput.value;
        const taskType = taskTypeInput.value;
        const description = descriptionInput.value.trim();
        const isUrgent = urgentInput.checked;

        if (newTaskText && startDate && taskType) {
          const task = {
            id: Date.now(),
            text: newTaskText,
            startDate: startDate,
            endDate: endDate || "לא צוין",
            priority: priority,
            description: description,
            type: taskType === "task" ? "משימה" : "פניה",
            comments: [],
            completionDate: null,
            urgent: isUrgent, // הוספת שדה דחוף
            isNearDeadline: false, // שדה חדש לבדיקת תאריך יעד
          };
          tasks.push(task);
          localStorage.setItem("tasks", JSON.stringify(tasks));
          newTaskInput.value = "";
          startDateInput.value = new Date(new Date().getTime() + 2 * 3600000)
            .toISOString()
            .slice(0, 16);
          endDateInput.value = "";
          priorityInput.value = "low";
          taskTypeInput.value = "";
          descriptionInput.value = "";
          urgentInput.checked = false;
          toggleDescription();
          renderTasks();
          showToast("הפניה/משימה נוספה בהצלחה!");
        } else {
          showToast("יש למלא את כל השדות המסומנים בכוכבית.");
        }
      }

      function deleteTask(id) {
        const task = tasks.find((task) => task.id === id);
        task.completionDate = new Date().toLocaleString("he-IL"); // הוספת תאריך סיום
        deletedTasks.push(task);
        tasks = tasks.filter((task) => task.id !== id);
        localStorage.setItem("tasks", JSON.stringify(tasks));
        localStorage.setItem("deletedTasks", JSON.stringify(deletedTasks));
        renderTasks();
        showToast("הפניה/משימה נמחקה בהצלחה!");
      }

      function editTask(id) {
        const task = tasks.find((task) => task.id === id);
        const newText = prompt("ערוך את הטקסט של הפניה:", task.text);
        if (newText !== null) {
          tasks = tasks.map((task) =>
            task.id === id ? { ...task, text: newText } : task
          );
          localStorage.setItem("tasks", JSON.stringify(tasks));
          renderTasks();
          showToast("הכותרת נערכה בהצלחה!");
        }
      }

      function editDescription(id) {
        const task = tasks.find((task) => task.id === id);
        const newDescription = prompt(
          "ערוך את התיאור של הפניה:",
          task.description
        );
        if (newDescription !== null) {
          tasks = tasks.map((task) =>
            task.id === id ? { ...task, description: newDescription } : task
          );
          localStorage.setItem("tasks", JSON.stringify(tasks));
          renderTasks();
          showToast("התיאור נערך בהצלחה!");
        }
      }

      function deleteTaskFromHistory(id) {
        const deleteConfirmationModal = new bootstrap.Modal(
          document.getElementById("deleteConfirmationModal")
        );
        deleteConfirmationModal.show();
        const confirmDeleteButton = document.getElementById(
          "confirmDeleteButton"
        );
        confirmDeleteButton.disabled = true;
        setTimeout(() => {
          confirmDeleteButton.disabled = false;
        }, 5000);
        confirmDeleteButton.onclick = function () {
          deletedTasks = deletedTasks.filter((task) => task.id !== id);
          localStorage.setItem("deletedTasks", JSON.stringify(deletedTasks));
          showHistory();
          showToast("הפניה/משימה נמחקה מההיסטוריה בהצלחה!");
          deleteConfirmationModal.hide();
        };
      }

      function changeTaskType(id, newType) {
        tasks = tasks.map((task) =>
          task.id === id ? { ...task, type: newType } : task
        );
        localStorage.setItem("tasks", JSON.stringify(tasks));
        renderTasks();
      }

      function renderTasks() {
        const taskAccordion = document.getElementById("taskAccordion");
        const requestAccordion = document.getElementById("requestAccordion");
        taskAccordion.innerHTML = "";
        requestAccordion.innerHTML = "";
        const sortedTasks = tasks.slice().sort((a, b) => {
          const priorityOrder = { high: 1, medium: 2, low: 3 };
          return priorityOrder[a.priority] - priorityOrder[b.priority];
        });
        sortedTasks.forEach((task) => {
          const taskItem = document.createElement("div");
          const nearDeadlineClass = task.isNearDeadline
            ? `near-deadline-${task.priority}`
            : "";
          taskItem.className = `task-item priority-${task.priority} ${nearDeadlineClass}`;
          taskItem.innerHTML = `
                              <div class="accordion-button" onclick="toggleAccordion(${
                                task.id
                              })">
                                <div class="d-flex justify-content-between w-100">
                                  <span>${task.text}</span>
                                  <span class="info-icon">
                                    ${
                                      task.urgent
                                        ? '<span class="urgent-dot"></span>'
                                        : ""
                                    }
                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                    <i class="fa-solid fa-calendar-days"></i>
                                    <div class="info-content">
                                      <p>תאריך התחלה: <span class="formatted-start-date">${formatDateTime(
                                        task.startDate
                                      )}</span></p>
                                      <hr>
                                      <p>תאריך יעד סופי: <span class="formatted-end-date">${formatDateTime(
                                        task.endDate
                                      )}</span></p>
                                    </div>
                                  </span>
                                </div>
                              </div>
                              <div id="accordion-content-${
                                task.id
                              }" class="accordion-content">
                                <p class="task-description">${
                                  task.description
                                }</p>
                                ${
                                  task.comments
                                    ? task.comments
                                        .map(
                                          (comment) => `
                                  <hr id="hr-${comment.id}">
                                  <div id="comment-${comment.id}">
                                    <p class="fw-bold">הערה (${comment.date}):</p>
                                    ${comment.text}
                                    <button class="btn btn-sm btn-primary" onclick="editComment(${task.id}, ${comment.id})">
                                      <i class="fa-solid fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteComment(${task.id}, ${comment.id})">
                                      <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                  </div>
                                `
                                        )
                                        .join("")
                                    : ""
                                }
                                <div class="task-actions d-flex justify-content-between align-items-center mb-2 mt-2">
                                  <div class="d-flex">
                                    <button class="btn btn-light btn-sm me-2 fw-bold" onclick="editTask(${
                                      task.id
                                    })">ערוך כותרת</button>
                                    <button class="btn btn-light btn-sm me-2 fw-bold" onclick="editDescription(${
                                      task.id
                                    })">ערוך תיאור</button>
                                    <button class="btn btn-light btn-sm me-2 fw-bold" onclick="addComment(${
                                      task.id
                                    })">הוסף הערה</button>
                                    <div class="dropdown">
                                      <button class="btn btn-light btn-sm dropdown-toggle me-2" type="button" id="priorityDropdown${
                                        task.id
                                      }" data-bs-toggle="dropdown" aria-expanded="false">
                                        רמת חשיבות
                                      </button>
                                      <ul class="dropdown-menu" aria-labelledby="priorityDropdown${
                                        task.id
                                      }">
                                        <li><a class="dropdown-item text-center" href="#" onclick="changeTaskPriority(${
                                          task.id
                                        }, 'low')">נמוכה</a></li>
                                        <li><a class="dropdown-item text-center" href="#" onclick="changeTaskPriority(${
                                          task.id
                                        }, 'medium')">בינונית</a></li>
                                        <li><a class="dropdown-item text-center" href="#" onclick="changeTaskPriority(${
                                          task.id
                                        }, 'high')">גבוהה</a></li>
                                      </ul>
                                    </div>
                                  </div>
                                  <div class="dropdown">
                                    <button class="btn btn-light btn-sm dropdown-toggle me-2 classification" type="button" id="taskTypeDropdown${
                                      task.id
                                    }" data-bs-toggle="dropdown" aria-expanded="false">
                                      סיווג
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="taskTypeDropdown${
                                      task.id
                                    }">
                                      <li><a class="dropdown-item text-center" href="#" onclick="changeTaskType(${
                                        task.id
                                      }, 'פניה')">פניה</a></li>
                                      <li><a class="dropdown-item text-center" href="#" onclick="changeTaskType(${
                                        task.id
                                      }, 'משימה')">משימה</a></li>
                                    </ul>
                                  </div>
                                  ${
                                    task.endDate && task.endDate !== "לא צוין"
                                      ? `<button class="btn btn-danger btn-sm fw-bold" onclick="stopBlink(${task.id})">כבה הבהוב</button>`
                                      : ""
                                  }
                                  <button class="btn btn-success btn-sm fw-bold" onclick="showCompletionReasonModal(${
                                    task.id
                                  })">סיום</button>
                                </div>
                              </div>
                            `;
          if (task.type === "משימה") {
            taskAccordion.appendChild(taskItem);
          } else {
            requestAccordion.appendChild(taskItem);
          }
        });
      }

      function stopBlink(id) {
        const task = tasks.find((task) => task.id === id);
        task.isNearDeadline = false;
        localStorage.setItem("tasks", JSON.stringify(tasks));
        renderTasks();
      }

      function checkDeadlines() {
        const now = new Date();
        tasks.forEach((task) => {
          const deadline = new Date(task.endDate);
          const timeDifference = deadline - now;
          if (timeDifference <= 86400000 && timeDifference > 0) {
            // 24 שעות
            task.isNearDeadline = true;
          } else {
            task.isNearDeadline = false;
          }
        });
        localStorage.setItem("tasks", JSON.stringify(tasks));
        renderTasks();
      }

      const style = document.createElement("style");
      style.innerHTML = `
                        .urgent-dot {
                          width: 10px;
                          height: 10px;
                          background-color: red;
                          border-radius: 50%;
                          animation: blink 1s infinite;
                          position: absolute;
                          top: 10px;
                          right: 10px;
                        }

                        @keyframes blink {
                          0%, 100% { opacity: 1; }
                          50% { opacity: 0; }
                        }

                        .near-deadline-high {
                          animation: soft-blink-high 2s infinite;
                        }

                        @keyframes soft-blink-high {
                          0%, 100% { background-color: #f8d7da; }
                          50% { background-color: #dc3545; }
                        }

                        .near-deadline-medium {
                          animation: soft-blink-medium 2s infinite;
                        }

                        @keyframes soft-blink-medium {
                          0%, 100% { background-color: #fff3cd; }
                          50% { background-color: #ffc107; }
                        }

                        .near-deadline-low {
                          animation: soft-blink-low 2s infinite;
                        }

                        @keyframes soft-blink-low {
                          0%, 100% { background-color: #d4edda; }
                          50% { background-color: #28a745; }
                        }
                      `;
      document.head.appendChild(style);

      // קריאה לפונקציה לבדיקת תאריכי יעד כל דקה
      setInterval(checkDeadlines, 60000);

      function toggleAccordion(id) {
        const content = document.getElementById(`accordion-content-${id}`);
        const button = content.previousElementSibling;
        content.classList.toggle("show");
        button.classList.toggle("active");
      }

      function showHistory() {
        const historyList = document.getElementById("historyList");
        if (!historyList) {
          console.error("Element with id 'historyList' not found.");
          return;
        }
        historyList.innerHTML = ""; // איפוס הרשימה
        deletedTasks.forEach((task) => {
          const listItem = document.createElement("li");
          listItem.className = "list-group-item";
          listItem.innerHTML = `
                            <div>
                              <strong><h4>${task.text}</h4></strong>
                              <p class="fw-bold m-0"><h5>תיאור: ${
                                task.description || "לא צוין"
                              }</h5></p>
                              <hr>
                              <p class="mb-0"><b>תאריך התחלה:</b> ${
                                task.startDate
                              }</p>
                              <p class="mb-0"><b>תאריך יעד סופי:</b> ${
                                task.endDate
                              }</p>
                              <p class="mb-0"><b>תאריך סיום:</b> ${
                                task.completionDate || "לא צוין"
                              }</p>
                              <p class="mb-0"><b>סיבת סיום:</b> ${
                                task.completionReason || "לא צוין"
                              }</p>
                              <button class="btn btn-primary btn-sm" onclick="restoreTask(${
                                task.id
                              })">שחזר</button>
                              <button class="btn btn-danger btn-sm" onclick="deleteTaskFromHistory(${
                                task.id
                              })">מחק</button>
                            </div>
                          `;
          historyList.appendChild(listItem);
        });
        // הצגת ה-Modal
        const historyModal = new bootstrap.Modal(
          document.getElementById("historyModal")
        );
        historyModal.show();
      }

      function toggleHistorySearch() {
        const searchInput = document.getElementById("historySearchInput");
        searchInput.classList.toggle("show");
      }

      function filterHistoryTasks() {
        const searchInput = document
          .getElementById("historySearchInput")
          .value.toLowerCase();
        const tasks = document.querySelectorAll(
          "#historyList .list-group-item"
        );
        tasks.forEach((task) => {
          const taskText = task.innerText.toLowerCase();
          if (taskText.includes(searchInput)) {
            task.style.display = "block";
          } else {
            task.style.display = "none";
          }
        });
      }

      function showAlerts() {
        const alertsList = document.getElementById("alertsList");
        alertsList.innerHTML = "";
        alerts.forEach((alert, index) => {
          const endDate = formatDateTime(alert.endDate);
          const listItem = document.createElement("li");
          listItem.className = "list-group-item";
          listItem.innerHTML = `
                            <div>
                              <strong>${alert.text}</strong>
                              <p>תאריך יעד סופי: ${endDate}</p>
                              <button class="btn btn-danger btn-sm" onclick="deleteAlert(${index})">מחק</button>
                            </div>
                          `;
          alertsList.appendChild(listItem);
        });
        const alertsModal = new bootstrap.Modal(
          document.getElementById("alertsModal")
        );
        alertsModal.show();
      }

      function deleteAlert(index) {
        alerts.splice(index, 1);
        localStorage.setItem("alerts", JSON.stringify(alerts));
        showAlerts();
        showToast("ההתראה נמחקה בהצלחה!");
      }

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("collapsed");
      }

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.innerText = message;
        toast.className = "toast show";
        setTimeout(() => {
          toast.className = toast.className.replace("show", "");
        }, 3000);
      }

      document.addEventListener("DOMContentLoaded", () => {
        checkAlertState();
      });

      function showDeadlineAlert(taskText, endDate) {
        const alert = document.getElementById("deadlineAlert");
        alert.querySelector(
          "strong"
        ).innerText = `תזכורת: משימה "${taskText}" קרובה לתאריך היעד לסיום `;
        alert.style.display = "block";
        alerts.push({ text: taskText, endDate: endDate });
        localStorage.setItem("alerts", JSON.stringify(alerts));
        localStorage.setItem("alertState", "visible");
      }

      function closeAlert() {
        const alert = document.getElementById("deadlineAlert");
        alert.style.display = "none";
        localStorage.setItem("alertState", "closed");
      }

      function checkAlertState() {
        const alertState = localStorage.getItem("alertState");
        const alert = document.getElementById("deadlineAlert");
        if (alertState === "visible") {
          alert.style.display = "block";
        } else if (alertState === "closed") {
          alert.style.display = "none";
        }
      }

      function addComment(id) {
        const task = tasks.find((task) => task.id === id);
        const newComment = prompt("הוסף הערה חדשה:");
        if (newComment !== null) {
          const now = new Date();
          const formattedDate = now.toLocaleString("he-IL");
          const commentId = Date.now(); // מזהה ייחודי להערה
          const updatedComments = [
            ...(task.comments || []),
            { id: commentId, text: newComment, date: formattedDate },
          ];
          tasks = tasks.map((task) =>
            task.id === id ? { ...task, comments: updatedComments } : task
          );
          localStorage.setItem("tasks", JSON.stringify(tasks));
          renderTasks();
          showToast("ההערה נוספה בהצלחה!");
        }
      }

      function deleteComment(taskId, commentId) {
        const task = tasks.find((task) => task.id === taskId);
        const updatedComments = task.comments.filter(
          (comment) => comment.id !== commentId
        );
        tasks = tasks.map((task) =>
          task.id === taskId ? { ...task, comments: updatedComments } : task
        );
        localStorage.setItem("tasks", JSON.stringify(tasks));
        renderTasks();
        showToast("ההערה נמחקה בהצלחה!");
      }

      function editComment(taskId, commentId) {
        const task = tasks.find((task) => task.id === taskId);
        const comment = task.comments.find(
          (comment) => comment.id === commentId
        );
        const newCommentText = prompt("ערוך את ההערה:", comment.text);
        if (newCommentText !== null) {
          const updatedComments = task.comments.map((comment) =>
            comment.id === commentId
              ? { ...comment, text: newCommentText }
              : comment
          );
          tasks = tasks.map((task) =>
            task.id === taskId ? { ...task, comments: updatedComments } : task
          );
          localStorage.setItem("tasks", JSON.stringify(tasks));
          renderTasks();
          showToast("ההערה נערכה בהצלחה!");
        }
      }

      function toggleSearch() {
        const searchInput = document.getElementById("searchInput");
        searchInput.classList.toggle("show");
      }

      function filterTasks() {
        const searchInput = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const tasks = document.querySelectorAll(".task-item");
        tasks.forEach((task) => {
          const taskText = task
            .querySelector(".accordion-button")
            .innerText.toLowerCase();
          if (taskText.includes(searchInput)) {
            task.style.display = "block";
          } else {
            task.style.display = "none";
          }
        });
      }

      function restoreTask(id) {
        const task = deletedTasks.find((task) => task.id === id);
        if (task) {
          tasks.push(task);
          deletedTasks = deletedTasks.filter((task) => task.id !== id);
          localStorage.setItem("tasks", JSON.stringify(tasks));
          localStorage.setItem("deletedTasks", JSON.stringify(deletedTasks));
          renderTasks();
          showHistory();
          showToast("הפניה/משימה שוחזרה בהצלחה!");
        }
      }

      const toggle = document.getElementById("darkModeToggle");
      const body = document.body;
      // Check local storage for dark mode preference
      if (localStorage.getItem("darkMode") === "enabled") {
        body.classList.add("dark-mode");
        toggle.checked = true;
      }
      toggle.addEventListener("change", () => {
        body.classList.toggle("dark-mode", toggle.checked);
        if (toggle.checked) {
          localStorage.setItem("darkMode", "enabled");
        } else {
          localStorage.setItem("darkMode", "disabled");
        }
      });

      function toggleSettings() {
        const settingsContent = document.getElementById("settingsContent");
        settingsContent.classList.toggle("show");
      }

      function toggleColumn(columnId, button) {
        const column = document.getElementById(columnId);
        const isHidden = column.style.display === "none";
        // הצגת/הסתרת העמודה
        column.style.display = isHidden ? "block" : "none";
        // הוספה או הסרה של מחלקת active לכפתור
        if (isHidden) {
          button.classList.remove("active"); // חזרה לצבע הקודם
        } else {
          button.classList.add("active"); // הפיכת הכפתור לאדום
        }
      }

      function showCompletionReasonModal(taskId) {
        const completionReasonModal = new bootstrap.Modal(
          document.getElementById("completionReasonModal")
        );
        document.getElementById("completionReasonForm").dataset.taskId = taskId;
        completionReasonModal.show();
        document.getElementById("completionReason").onchange = function () {
          const otherReasonGroup = document.getElementById("otherReasonGroup");
          otherReasonGroup.style.display =
            this.value === "אחר" ? "block" : "none";
        };
      }

      function completeTask() {
        const taskId = document.getElementById("completionReasonForm").dataset
          .taskId;
        const task = tasks.find((task) => task.id === parseInt(taskId));
        const completionReason =
          document.getElementById("completionReason").value;
        const otherReason = document.getElementById("otherReason").value.trim();
        task.completionReason =
          completionReason === "אחר" ? otherReason : completionReason;
        task.completionDate = new Date().toLocaleString("he-IL"); // הוספת תאריך סיום
        deletedTasks.push(task);
        tasks = tasks.filter((task) => task.id !== parseInt(taskId));
        localStorage.setItem("tasks", JSON.stringify(tasks));
        localStorage.setItem("deletedTasks", JSON.stringify(deletedTasks));
        renderTasks();
        showToast("הפניה/משימה סויימה בהצלחה!");
        const completionReasonModal = bootstrap.Modal.getInstance(
          document.getElementById("completionReasonModal")
        );
        completionReasonModal.hide();
      }

      function formatDateTime(dateTime) {
        if (!dateTime) {
          return "לא צוין";
        }
        const date = new Date(dateTime);
        if (isNaN(date.getTime())) {
          return "לא צוין";
        }
        const hours = date.getHours().toString().padStart(2, "0");
        const minutes = date.getMinutes().toString().padStart(2, "0");
        const day = date.getDate().toString().padStart(2, "0");
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const year = date.getFullYear();
        return `${hours}:${minutes}, ${day}/${month}/${year}`;
      }

      function scheduleBackup() {
        const now = new Date();
        const targetHour = 18; // השעה שבה תרצה לבצע את הגיבוי (24 שעות)
        const targetMinute = 0; // הדקה שבה תרצה לבצע את הגיבוי
        const targetSecond = 0; // השנייה שבה תרצה לבצע את הגיבוי
        const targetTime = new Date();
        targetTime.setHours(targetHour, targetMinute, targetSecond, 0);
        if (now > targetTime) {
          targetTime.setDate(targetTime.getDate() + 1); // אם השעה כבר עברה היום, קבע למחר
        }
        const timeUntilBackup = targetTime - now;
        setTimeout(() => {
          exportData(); // ביצוע הגיבוי
          setInterval(exportData, 24 * 60 * 60 * 1000); // קביעת גיבוי כל 24 שעות
        }, timeUntilBackup);
      }

      document.addEventListener("DOMContentLoaded", () => {
        scheduleBackup(); // קריאה לפונקציה לקביעת גיבוי אוטומטי
      });

      function showTooltip(id) {
        document.getElementById(id).style.display = "block";
      }

      function hideTooltip(id) {
        document.getElementById(id).style.display = "none";
      }

      function exportData() {
        const data = {
          tasks: tasks,
          deletedTasks: deletedTasks,
          alerts: alerts,
        };
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "backup.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importData(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const data = JSON.parse(e.target.result);
            tasks = data.tasks || [];
            deletedTasks = data.deletedTasks || [];
            alerts = data.alerts || [];
            localStorage.setItem("tasks", JSON.stringify(tasks));
            localStorage.setItem("deletedTasks", JSON.stringify(deletedTasks));
            localStorage.setItem("alerts", JSON.stringify(alerts));
            renderTasks();
            showToast("הנתונים יובאו בהצלחה!");
          };
          reader.readAsText(file);
        }
      }

      /*שינוי רמת חשיבות לפניה/משימה*/
      function changeTaskPriority(id, newPriority) {
        tasks = tasks.map((task) =>
          task.id === id ? { ...task, priority: newPriority } : task
        );
        localStorage.setItem("tasks", JSON.stringify(tasks));
        renderTasks();
      }

      /*לוח שנה*/
      document.addEventListener("DOMContentLoaded", function () {
        var calendarEl = document.getElementById("calendar");
        var eventCountBadge = document.getElementById("eventCountBadge");
        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay",
          },
          locale: "he", // הגדרת השפה לעברית
          height: "auto", // התאמת גובה היומן
          events: JSON.parse(localStorage.getItem("calendarEvents")) || [], // טעינת אירועים מ-LocalStorage
          dateClick: function (info) {
            var addEventModal = new bootstrap.Modal(
              document.getElementById("addEventModal")
            );
            var addEventForm = document.getElementById("addEventForm");
            var localDateTime = new Date(info.dateStr)
              .toISOString()
              .slice(0, 16); // סימון אוטומטי של התאריך והשעה
            document.getElementById("newEventDate").value = localDateTime;
            addEventModal.show();
          },
          eventClick: function (info) {
            var editEventModal = new bootstrap.Modal(
              document.getElementById("editEventModal")
            );
            var editEventForm = document.getElementById("editEventForm");
            editEventForm.event = info.event; // שמירת האירוע לעריכה
            document.getElementById("eventTitle").value = info.event.title;
            document.getElementById("eventDate").value = new Date(
              info.event.start
            )
              .toLocaleString("sv-SE", { timeZoneName: "short" })
              .slice(0, 16);
            editEventModal.show();
          },
        });
        calendar.render();

        // פונקציה להצגת התראה בעמוד הראשי
        function showAlert() {
          var alert = document.getElementById("alert");
          alert.style.display = "block";
        }

        // פונקציה לסגירת התראה
        function closeAlert() {
          var alert = document.getElementById("alert");
          alert.style.display = "none";
        }

        // פונקציה לשמירת אירועים ב-LocalStorage
        function saveEventsToLocalStorage(events) {
          var eventsArray = events.map(function (event) {
            return {
              title: event.title,
              start: event.start,
              allDay: event.allDay,
            };
          });
          localStorage.setItem("calendarEvents", JSON.stringify(eventsArray));
          updateEventCountBadge(eventsArray);
        }

        // פונקציה לעדכון מספר האירועים שהגיעו ליעד שלהם או חלפו את היעד שלהם
        function updateEventCountBadge(events) {
          var now = new Date();
          var count = events.filter(function (event) {
            var eventDate = new Date(event.start);
            return eventDate <= now;
          }).length;
          if (count > 0) {
            eventCountBadge.textContent = count;
            eventCountBadge.style.display = "inline";
          } else {
            eventCountBadge.style.display = "none";
          }
        }

        // בדיקת תאריכי יעד כל דקה
        setInterval(function () {
          var now = new Date();
          calendar.getEvents().forEach(function (event) {
            var eventDate = new Date(event.start);
            if (
              eventDate <= now &&
              eventDate >= new Date(now.getTime() - 1800000)
            ) {
              // חצי שעה לפני התאריך ושעת היעד
              showAlert();
            }
          });
          updateEventCountBadge(calendar.getEvents());
        }, 60000);

        // טיפול בטופס הוספת אירוע
        document
          .getElementById("addEventForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            var title = document.getElementById("newEventTitle").value;
            var date = document.getElementById("newEventDate").value;
            if (title && date) {
              var newEvent = {
                title: title,
                start: new Date(date).toISOString(), // שמירת השעה המדויקת
                allDay: false,
              };
              calendar.addEvent(newEvent);
              saveEventsToLocalStorage(calendar.getEvents());
              var addEventModal = bootstrap.Modal.getInstance(
                document.getElementById("addEventModal")
              );
              addEventModal.hide();
            }
          });

        // טיפול בטופס עריכת אירוע
        document
          .getElementById("editEventForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            var event = e.target.event;
            var newTitle = document.getElementById("eventTitle").value;
            var newDate = document.getElementById("eventDate").value;
            if (newTitle && newDate) {
              event.setProp("title", newTitle);
              event.setStart(new Date(newDate).toISOString()); // שמירת השעה המדויקת
              saveEventsToLocalStorage(calendar.getEvents());
              var editEventModal = bootstrap.Modal.getInstance(
                document.getElementById("editEventModal")
              );
              editEventModal.hide();
            }
          });

        // טיפול בכפתור מחיקת אירוע
        document
          .getElementById("deleteEventButton")
          .addEventListener("click", function () {
            var event = document.getElementById("editEventForm").event;
            event.remove();
            saveEventsToLocalStorage(calendar.getEvents());
            var editEventModal = bootstrap.Modal.getInstance(
              document.getElementById("editEventModal")
            );
            editEventModal.hide();
          });

        // עדכון מספר האירועים שהגיעו ליעד שלהם או חלפו את היעד שלהם בהתחלה
        updateEventCountBadge(calendar.getEvents());
      });
    </script>
  </body>
</html>
